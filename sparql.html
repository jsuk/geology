<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geological Time Scale SPARQL Query</title>
  <link rel="stylesheet" href="https://rdf.js.org/comunica-browser/versions/v4/engines/query-sparql/comunica-browser.css">
</head>
<body>
  <h1>Geological Time Scale SPARQL Query</h1>
  <label for="rank-selector">Select Rank 1:</label>
  <select id="rank-selector">
    <option value="Super-Eon">Super-Eon</option>
    <option value="Eon">Eon</option>
    <option value="Era">Era</option>
    <option value="Period">Period</option>
    <option value="Epoch">Epoch</option>
    <option value="Age">Age</option>
  </select>
  <label for="rank-selector-2">Select Rank 2:</label>
  <select id="rank-selector-2">
    <option value="none">None</option>
    <option value="Super-Eon">Super-Eon</option>
    <option value="Eon">Eon</option>
    <option value="Era">Era</option>
    <option value="Period">Period</option>
    <option value="Epoch">Epoch</option>
    <option value="Age">Age</option>
  </select>
  <button id="linear-scale-btn">Linear Scale</button>
  <button id="log-scale-btn">Logarithmic Scale</button>
  <button id="stacked-bar-btn">Stacked Bar</button>
  <div id="results">
    <canvas id="timeRangeChart"></canvas>
    <table id="results-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>From (mya)</th>
          <th>To (mya)</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://rdf.js.org/comunica-browser/versions/v4/engines/query-sparql/comunica-browser.js"></script>
<script language="JavaScript">
  const rankSelector = document.getElementById('rank-selector');
  const rankSelector2 = document.getElementById('rank-selector-2');
  const resultsTableBody = document.querySelector('#results-table tbody');
  const ctx = document.getElementById('timeRangeChart').getContext('2d');
  const linearScaleBtn = document.getElementById('linear-scale-btn');
  const logScaleBtn = document.getElementById('log-scale-btn');
  const engine = new Comunica.QueryEngine();
  const stackedBarBtn = document.getElementById('stacked-bar-btn');
  let timeRangeChart;
  let originalData = [];
  let logData = [];
  let chartLabels = [];
  let currentScaleType = 'linear'; // Default to linear scale
  let currentChartType = 'bar'; // Default to bar chart

  function updateChartType(chartType) {
    currentChartType = chartType;
    if (currentChartType === 'stacked') {
      stackedBarBtn.textContent = 'Bar Chart';
    } else {
      stackedBarBtn.textContent = 'Stacked Bar';
    }
    executeQuery(); // Re-execute query to redraw chart with new type
  }

  function updateChartScale(scaleType) {
    currentScaleType = scaleType;
    if (currentChartType === 'stacked') { // If stacked, scale doesn't apply to x-axis
      executeQuery();
      return;
    }
    if (!timeRangeChart) return;
    const isLog = scaleType === 'logarithmic';
    timeRangeChart.data.datasets[0].data = isLog ? logData : originalData;
    timeRangeChart.options.scales.x.type = scaleType;
    timeRangeChart.options.scales.x.title.text = isLog ? 'Millions of Years Ago (mya) - Log Scale' : 'Millions of Years Ago (mya)';
    timeRangeChart.options.scales.x.min = isLog ? 0.001 : 0;
    timeRangeChart.update();
  }

  function executeQuery() {
    const selectedRank = rankSelector.value;
    const selectedRank2 = rankSelector2.value;
    resultsTableBody.innerHTML = ''; // Clear previous results

    // Reset data arrays
    chartLabels = [];
    originalData = [];
    logData = [];

    const query = (rank) => `
PREFIX ti: <http://www.ontologydesignpatterns.org/cp/owl/timeinterval.owl#>
PREFIX cs: <http://resource.geosciml.org/classifier/ics/ischart>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX gts: <http://resource.geosciml.org/ontology/timescale/gts#>
PREFIX ischart: <http://resource.geosciml.org/classifier/ics/ischart/>
PREFIX owl: <http://www.w3.org/2002/07/owl#>
PREFIX prov: <http://www.w3.org/ns/prov#>
PREFIX rank: <http://resource.geosciml.org/ontology/timescale/rank/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX sdo: <https://schema.org/>
PREFIX sh: <http://www.w3.org/ns/shacl#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX time: <http://www.w3.org/2006/time#>
PREFIX ts: <http://resource.geosciml.org/vocabulary/timescale/>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

SELECT ?x ?from ?to ?color
WHERE {
  ?x a skos:Concept;
  skos:prefLabel ?title;
  gts:rank rank:${rank};
  time:hasBeginning ?bt;
  time:hasEnd ?et.
  ?bt ischart:inMYA ?from.
  ?et ischart:inMYA ?to.
  OPTIONAL { ?x sdo:color ?color . }
} ORDER BY asc(?to)
`;

    const sources = ['https://stratigraphy.org/ICSchart/data/ChronostratChart2024-12.ttl'];

    const promise1 = engine.queryBindings(query(selectedRank), { sources });
    const promise2 = selectedRank2 !== 'none' ? engine.queryBindings(query(selectedRank2), { sources }) : Promise.resolve(null);

    Promise.all([promise1, promise2]).then(([bindingsStream1, bindingsStream2]) => {
        const processStream = (stream, dataArray) => {
            return new Promise((resolve) => {
                if (!stream) return resolve();
                stream.on('data', function (data) {
                    const name = data.get('x').value.split('/').pop();
                    const from = parseFloat(data.get('from').value);
                    const to = parseFloat(data.get('to').value);
                    const color = data.get('color') ? data.get('color').value : 'rgba(54, 162, 235, 0.5)';

                    if (!chartLabels.includes(name)) {
                        chartLabels.push(name);
                    }
                    dataArray.push({x: [to, from], y: name, color: color});
                });
                stream.on('end', resolve);
            });
        };

        const data1 = [];
        const data2 = [];

        Promise.all([processStream(bindingsStream1, data1), processStream(bindingsStream2, data2)]).then(() => {
            originalData = [data1, data2.length > 0 ? data2 : null].filter(d => d);
            logData = originalData.map(dataset => dataset.map(item => ({...item, x: [item.x[0] === 0 ? 0.001 : item.x[0], item.x[1]]})));

            // Update table with data from the first rank
            data1.forEach(item => {
                const row = resultsTableBody.insertRow();
                row.insertCell().textContent = item.y;
                row.insertCell().textContent = item.x[1];
                row.insertCell().textContent = item.x[0];
            });

            const chartContainer = document.getElementById('results');
            const newHeight = (chartLabels.length * 50) + 100;
            chartContainer.style.height = `${newHeight}px`;

            if (timeRangeChart) {
                timeRangeChart.destroy();
            }

            let chartConfig;

            if (currentChartType === 'stacked') {
                const datasets = originalData.map((dataset, index) => {
                    return dataset.map(item => {
                        const duration = item.x[1] - item.x[0];
                        return {
                            label: item.y,
                            data: [duration],
                            backgroundColor: item.color,
                            borderColor: item.color,
                            borderWidth: 1,
                            stack: `stack${index}`
                        };
                    });
                }).flat();

                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: ['Geological Time'],
                        datasets: datasets
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                stacked: true,
                                min: 0,
                                title: {
                                    display: true,
                                    text: 'Millions of Years Ago (mya)'
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `Geological Time Scale - Stacked Bar for ${selectedRank} and ${selectedRank2}`
                            }
                        }
                    }
                };
            } else {
                const datasets = originalData.map((dataset, index) => ({
                    label: `Geological Time Range (mya) - ${index === 0 ? selectedRank : selectedRank2}`,
                    data: currentScaleType === 'logarithmic' ? logData[index] : dataset,
                    backgroundColor: dataset.map(item => item.color),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    minBarLength: 2
                }));

                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: datasets
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                type: currentScaleType,
                                min: currentScaleType === 'logarithmic' ? 0.001 : 0,
                                title: {
                                    display: true,
                                    text: currentScaleType === 'logarithmic' ? 'Millions of Years Ago (mya) - Log Scale' : 'Millions of Years Ago (mya)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    padding: 40
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `Geological Time Ranges for ${selectedRank} and ${selectedRank2}`
                            }
                        }
                    }
                };
            }
            timeRangeChart = new Chart(ctx, chartConfig);
        });
    });
  }

  rankSelector.addEventListener('change', executeQuery);
  rankSelector2.addEventListener('change', executeQuery);
  linearScaleBtn.addEventListener('click', () => updateChartScale('linear'));
  logScaleBtn.addEventListener('click', () => updateChartScale('logarithmic'));
  document.getElementById('stacked-bar-btn').addEventListener('click', () => {
    if (currentChartType === 'stacked') {
      updateChartType('bar');
    } else {
      updateChartType('stacked');
    }
  });

  // Initial query execution
  executeQuery();
</script>
<script>
  // Ensure the Comunica library is loaded
  if (typeof Comunica === 'undefined') {
    console.error('Comunica library is not loaded.');
  } else {
    console.log('Comunica library loaded successfully.');
  }
</script>


</html>
